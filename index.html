<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="doganciftci">

  <title>IOL Serial Number Scanner</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic"/>
  <!-- Roboto Font -->
  <link rel="stylesheet" href="fonts/roboto.css" />

    <!-- Normalize CSS -->
    <link rel="stylesheet" href="css/normalize.css" />

    <!-- Milligram CSS -->
    <link rel="stylesheet" href="css/milligram.min.css" />

    <!-- interpretGS1Scan Styles -->
    <link rel="stylesheet" href="css/interpretGS1ScanStyles.css" />

    <!-- JS Libraries -->
    <script src="js/GS1DigitalLinkToolkit.js"></script>
    <script src="js/interpretGS1Scan.js"></script>
    <script src="js/plausibleGS1DL.js"></script>
    <script src="js/beep.js"></script>

  <style>
    .button {
      background-color: #abaca9; /* Change this to any color you like */
      color: rgb(49, 5, 209); /* Ensure the text color is readable */
    }
    h1.title {
      font-size:1.5em;
    }

    footer {
      margin-top: 2em;
      padding-top:1em;
      border-top: thin solid #999;
    }

    .video-table-container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-top: 1em;
    }

    .video-container {
      flex: 1;
    }

    .table-container {
      flex: 1;
      padding-left: 2em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table, th, td {
      border: 1px solid gray;
    }

    th, td {
      padding: 8px;
      text-align: center;
    }

    #exportButton {
      display: none;
    }
  </style>

</head>

<body>

  <main class="wrapper" style="padding-top:2em">

    <section class="container" id="demo-content">
      <h1 class="title">Scan the code on te IOL box with your device's video camera</h1>

      <div>
        <a class="button" id="startButton">Start</a>
        <a class="button" id="resetButton">Reset</a>
      </div>

      <!-- Export Button -->
      <div>
        <a class="button" id="exportButton">Export to CSV</a>
      </div>

      <div class="video-table-container">
        <!-- Video Container -->
        <div class="video-container">
          <video id="video" width="300" height="200" style="border: 1px solid gray"></video>
        </div>
        <div id="messageContainer" style="color: red; display: none; margin-top: 10px;"></div>

        <!-- Table Container -->
        <div class="table-container">
          <table id="serialNumbersTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Serial Number</th>
              </tr>
            </thead>
            <tbody>
              <!-- Serial numbers will be added dynamically here -->
            </tbody>
          </table>
        </div>
      </div>

      <div id="sourceSelectPanel" style="display:none">
        <label for="sourceSelect">Change video source:</label>
        <select id="sourceSelect" style="max-width:400px">
        </select>
      </div>
    </section>

  </main>

  <script type="text/javascript" src="js/index.min.js"></script>
  <script type="text/javascript">
    window.addEventListener('load', function () {
        let selectedDeviceId;
        let serialCount = 0; 
        const codeReader = new ZXing.BrowserMultiFormatReader();
        const exportButton = document.getElementById('exportButton');
        const table = document.getElementById('serialNumbersTable').getElementsByTagName('tbody')[0];
        const scannedSerialNumbers = new Set(); 
        const messageContainer = document.getElementById('messageContainer'); // Message container

        console.log('ZXing code reader initialized');
        codeReader.listVideoInputDevices()
            .then((videoInputDevices) => {
                const sourceSelect = document.getElementById('sourceSelect');
                selectedDeviceId = videoInputDevices[0].deviceId;
                // (existing code for device selection omitted for brevity)
                document.getElementById('startButton').addEventListener('click', () => {
                    codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
                        if (result) {
                            console.log(result);

                            let re = new RegExp(String.fromCharCode(29), "g");
                            let resultText = result.text.replace(re, "<GS>");
                            let snMatch = resultText.substring(38);

                            if (snMatch) {
                                if (!scannedSerialNumbers.has(snMatch)) {
                                    console.log('Scanned Serial Number:', snMatch);
                                    scannedSerialNumbers.add(snMatch); 

                                    serialCount++;
                                    let newRow = table.insertRow();
                                    let cell1 = newRow.insertCell(0);
                                    let cell2 = newRow.insertCell(1);
                                    cell1.textContent = serialCount;
                                    cell2.textContent = snMatch;

                                    beep.play();

                                    exportButton.style.display = 'block';
                                } else {
                                    console.log('Duplicate Serial Number detected:', snMatch);
                                    showMessage('This serial number is already scanned and can be found in the table!'); // Show duplicate message
                                }
                            } else {
                                console.log('Serial Number not found.');
                            }
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.error(err);
                        }
                    });
                    console.log(`Started continuous decode from camera with id ${selectedDeviceId}`);
                });
                // (reset and export button functionality omitted for brevity)
            })
            .catch((err) => {
                console.error(err);
            });

        function showMessage(message) {
            messageContainer.textContent = message;
            messageContainer.style.display = 'block'; // Show the message
            setTimeout(function() {
                messageContainer.style.display = 'none'; // Hide after 2 seconds
            }, 2000);
        }
        // CSV export functions
        function exportTableToCSV(filename) {
            let csv = [];
            let rows = document.querySelectorAll("#serialNumbersTable tr");
            for (let i = 0; i < rows.length; i++) {
                let row = [], cols = rows[i].querySelectorAll("td, th");
                cols.forEach(function(col) {
                    row.push(col.innerText);
                });
                csv.push(row.join(","));
            }
            downloadCSV(csv.join("\n"), filename);
        }

        function downloadCSV(csv, filename) {
            let csvFile;
            let downloadLink;
            csvFile = new Blob([csv], {type: "text/csv"});
            downloadLink = document.createElement("a");
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
        }

        exportButton.addEventListener('click', () => {
            exportTableToCSV('serial_numbers.csv');
        });
    });
</script>



</body>

</html>
